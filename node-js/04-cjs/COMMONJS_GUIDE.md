# üì¶ Guia Completo: CommonJS - Sistema de M√≥dulos do Node.js

## üéØ Introdu√ß√£o ao CommonJS

CommonJS √© o sistema de m√≥dulos original e padr√£o do Node.js, desenvolvido para permitir a modulariza√ß√£o de aplica√ß√µes JavaScript no servidor. Utiliza `require()` para importar e `module.exports` para exportar m√≥dulos.

### üèóÔ∏è Caracter√≠sticas do CommonJS

- **Carregamento s√≠ncrono**: M√≥dulos s√£o carregados de forma bloqueante
- **Din√¢mico**: Importa√ß√µes podem ser condicionais
- **Compatibilidade**: Funciona nativamente no Node.js
- **Simplicidade**: Sintaxe direta e intuitiva
- **Caching**: M√≥dulos s√£o armazenados em cache ap√≥s a primeira importa√ß√£o

## üìö √çndice

1. [Sintaxe B√°sica](#sintaxe-b√°sica)
2. [Padr√µes de Exporta√ß√£o](#padr√µes-de-exporta√ß√£o)
3. [Padr√µes de Importa√ß√£o](#padr√µes-de-importa√ß√£o)
4. [Exemplos Pr√°ticos](#exemplos-pr√°ticos)
5. [Sistema de Cache](#sistema-de-cache)
6. [Resolu√ß√£o de M√≥dulos](#resolu√ß√£o-de-m√≥dulos)
7. [Boas Pr√°ticas](#boas-pr√°ticas)
8. [Patterns Avan√ßados](#patterns-avan√ßados)

## üîß Sintaxe B√°sica

### Exporta√ß√£o (`module.exports`)

```javascript
// Exporta√ß√£o de objeto
module.exports = {
    nome: 'Jo√£o',
    idade: 30,
    saudar: function() {
        return `Ol√°, eu sou ${this.nome}`;
    }
};

// Exporta√ß√£o de fun√ß√£o √∫nica
module.exports = function calcular(a, b) {
    return a + b;
};

// Exporta√ß√£o de classe
module.exports = class Usuario {
    constructor(nome) {
        this.nome = nome;
    }
};

// Exporta√ß√£o usando exports (atalho)
exports.PI = 3.14159;
exports.dobrar = (x) => x * 2;
```

### Importa√ß√£o (`require()`)

```javascript
// Importa√ß√£o completa
const usuario = require('./usuario');
const calcular = require('./calculadora');

// Desestrutura√ß√£o
const { PI, dobrar } = require('./matematica');
const { nome, idade, saudar } = require('./pessoa');

// Importa√ß√£o com renomea√ß√£o
const { calcular: somar } = require('./operacoes');

// Importa√ß√£o de m√≥dulos do core
const fs = require('fs');
const path = require('path');
const http = require('http');
```

## üì§ Padr√µes de Exporta√ß√£o

### 1. Exporta√ß√£o de Objeto

```javascript
// utils/helpers.js
function formatarData(data) {
    return data.toLocaleDateString('pt-BR');
}

function validarEmail(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regex.test(email);
}

const CONSTANTES = {
    MAX_TENTATIVAS: 3,
    TIMEOUT: 5000
};

module.exports = {
    formatarData,
    validarEmail,
    CONSTANTES
};
```

### 2. Exporta√ß√£o de Fun√ß√£o Principal

```javascript
// services/logger.js
function log(nivel, mensagem) {
    const timestamp = new Date().toISOString();
    console.log(`[${timestamp}] ${nivel.toUpperCase()}: ${mensagem}`);
}

// Fun√ß√£o principal
module.exports = log;

// M√©todos adicionais
module.exports.info = (msg) => log('info', msg);
module.exports.error = (msg) => log('error', msg);
module.exports.warn = (msg) => log('warn', msg);
```

### 3. Exporta√ß√£o de Classe

```javascript
// models/Produto.js
class Produto {
    constructor(nome, preco, categoria) {
        this.id = this.gerarId();
        this.nome = nome;
        this.preco = preco;
        this.categoria = categoria;
        this.criadoEm = new Date();
    }

    gerarId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    aplicarDesconto(percentual) {
        this.preco *= (1 - percentual / 100);
        return this;
    }

    toJSON() {
        return {
            id: this.id,
            nome: this.nome,
            preco: this.preco,
            categoria: this.categoria,
            criadoEm: this.criadoEm
        };
    }
}

// Constantes relacionadas
const CATEGORIAS = {
    ELETR√îNICOS: 'eletr√¥nicos',
    ROUPAS: 'roupas',
    LIVROS: 'livros'
};

module.exports = Produto;
module.exports.CATEGORIAS = CATEGORIAS;
```

### 4. Exporta√ß√£o Progressiva

```javascript
// config/server.js
const config = {};

// Configura√ß√µes b√°sicas
config.port = process.env.PORT || 3000;
config.host = process.env.HOST || 'localhost';

// Configura√ß√µes de banco
config.database = {
    host: process.env.DB_HOST || 'localhost',
    port: process.env.DB_PORT || 5432,
    name: process.env.DB_NAME || 'app_dev'
};

// Configura√ß√µes de seguran√ßa
config.jwt = {
    secret: process.env.JWT_SECRET || 'dev-secret',
    expiresIn: '24h'
};

module.exports = config;
```

## üì• Padr√µes de Importa√ß√£o

### 1. Importa√ß√£o B√°sica

```javascript
// M√≥dulo completo
const express = require('express');
const lodash = require('lodash');

// M√≥dulos locais
const Usuario = require('./models/Usuario');
const { formatarData, validarEmail } = require('./utils/helpers');
```

### 2. Importa√ß√£o Condicional

```javascript
// Carregamento baseado em ambiente
let config;
if (process.env.NODE_ENV === 'production') {
    config = require('./config/production');
} else {
    config = require('./config/development');
}

// Plugin opcional
let plugin = null;
try {
    plugin = require('plugin-opcional');
} catch (error) {
    console.log('Plugin opcional n√£o encontrado');
}
```

### 3. Importa√ß√£o Din√¢mica

```javascript
// Carregamento din√¢mico de m√≥dulos
function carregarModulo(nome) {
    try {
        return require(`./plugins/${nome}`);
    } catch (error) {
        console.error(`Erro ao carregar m√≥dulo ${nome}:`, error.message);
        return null;
    }
}

// Cache de m√≥dulos carregados
const modulosCarregados = {};

function obterModulo(nome) {
    if (!modulosCarregados[nome]) {
        modulosCarregados[nome] = require(`./modules/${nome}`);
    }
    return modulosCarregados[nome];
}
```

## üí° Exemplos Pr√°ticos

### Exemplo 1: Sistema de Log

```javascript
// utils/logger.js
const fs = require('fs');
const path = require('path');

class Logger {
    constructor(logDir = 'logs') {
        this.logDir = logDir;
        this.ensureLogDir();
    }

    ensureLogDir() {
        if (!fs.existsSync(this.logDir)) {
            fs.mkdirSync(this.logDir, { recursive: true });
        }
    }

    log(level, message, data = null) {
        const timestamp = new Date().toISOString();
        const logEntry = {
            timestamp,
            level: level.toUpperCase(),
            message,
            data
        };

        // Console output
        console.log(`[${timestamp}] ${level.toUpperCase()}: ${message}`);

        // File output
        const logFile = path.join(this.logDir, `${level}.log`);
        fs.appendFileSync(logFile, JSON.stringify(logEntry) + '\n');
    }

    info(message, data) {
        this.log('info', message, data);
    }

    error(message, data) {
        this.log('error', message, data);
    }

    warn(message, data) {
        this.log('warn', message, data);
    }

    debug(message, data) {
        if (process.env.NODE_ENV === 'development') {
            this.log('debug', message, data);
        }
    }
}

// Singleton instance
const logger = new Logger();

module.exports = logger;
module.exports.Logger = Logger;
```

### Exemplo 2: Gerenciador de Configura√ß√£o

```javascript
// config/index.js
const path = require('path');
const fs = require('fs');

class ConfigManager {
    constructor() {
        this.config = {};
        this.loadConfig();
    }

    loadConfig() {
        const env = process.env.NODE_ENV || 'development';
        
        // Configura√ß√£o base
        const baseConfig = this.loadFile('base.json');
        
        // Configura√ß√£o espec√≠fica do ambiente
        const envConfig = this.loadFile(`${env}.json`);
        
        // Configura√ß√£o local (ignorada pelo git)
        const localConfig = this.loadFile('local.json');

        // Merge das configura√ß√µes
        this.config = {
            ...baseConfig,
            ...envConfig,
            ...localConfig,
            env
        };
    }

    loadFile(filename) {
        const configPath = path.join(__dirname, filename);
        
        try {
            if (fs.existsSync(configPath)) {
                const content = fs.readFileSync(configPath, 'utf8');
                return JSON.parse(content);
            }
        } catch (error) {
            console.warn(`Erro ao carregar configura√ß√£o ${filename}:`, error.message);
        }
        
        return {};
    }

    get(key, defaultValue = null) {
        return this.config[key] || defaultValue;
    }

    set(key, value) {
        this.config[key] = value;
    }

    getAll() {
        return { ...this.config };
    }
}

module.exports = new ConfigManager();
```

### Exemplo 3: Factory Pattern

```javascript
// factories/DatabaseFactory.js
const mysql = require('mysql2');
const { Pool } = require('pg');
const { MongoClient } = require('mongodb');

class DatabaseFactory {
    static createConnection(type, config) {
        switch (type.toLowerCase()) {
            case 'mysql':
                return DatabaseFactory.createMySQL(config);
            case 'postgresql':
            case 'postgres':
                return DatabaseFactory.createPostgreSQL(config);
            case 'mongodb':
            case 'mongo':
                return DatabaseFactory.createMongoDB(config);
            default:
                throw new Error(`Tipo de banco n√£o suportado: ${type}`);
        }
    }

    static createMySQL(config) {
        return mysql.createConnection({
            host: config.host,
            user: config.username,
            password: config.password,
            database: config.database,
            port: config.port || 3306
        });
    }

    static createPostgreSQL(config) {
        return new Pool({
            host: config.host,
            user: config.username,
            password: config.password,
            database: config.database,
            port: config.port || 5432
        });
    }

    static async createMongoDB(config) {
        const url = `mongodb://${config.host}:${config.port || 27017}/${config.database}`;
        const client = new MongoClient(url);
        await client.connect();
        return client.db(config.database);
    }
}

module.exports = DatabaseFactory;
```

## üóÇÔ∏è Sistema de Cache

### Como Funciona o Cache

```javascript
// Demonstra√ß√£o do sistema de cache do Node.js
console.log('Cache inicial:', Object.keys(require.cache));

// Primeira importa√ß√£o - m√≥dulo √© executado
const modulo1 = require('./meuModulo');
console.log('Ap√≥s primeira importa√ß√£o:', Object.keys(require.cache));

// Segunda importa√ß√£o - retorna do cache
const modulo2 = require('./meuModulo');
console.log('modulo1 === modulo2:', modulo1 === modulo2); // true
```

### Manipulando o Cache

```javascript
// utils/cacheManager.js
function limparCache(modulePath) {
    const fullPath = require.resolve(modulePath);
    delete require.cache[fullPath];
}

function recarregarModulo(modulePath) {
    limparCache(modulePath);
    return require(modulePath);
}

function listarModulosCache() {
    return Object.keys(require.cache);
}

function limparTodoCache() {
    Object.keys(require.cache).forEach(key => {
        delete require.cache[key];
    });
}

module.exports = {
    limparCache,
    recarregarModulo,
    listarModulosCache,
    limparTodoCache
};
```

## üîç Resolu√ß√£o de M√≥dulos

### Algoritmo de Resolu√ß√£o

O Node.js segue esta ordem para resolver m√≥dulos:

1. **Core Modules**: `fs`, `path`, `http`, etc.
2. **Caminhos Relativos**: `./`, `../`
3. **node_modules**: Sobe a √°rvore de diret√≥rios

### Exemplos de Resolu√ß√£o

```javascript
// 1. Core module (prioridade m√°xima)
const fs = require('fs');

// 2. Caminho relativo
const utils = require('./utils/helpers');
const config = require('../config/app');

// 3. node_modules (busca na √°rvore de diret√≥rios)
const express = require('express');
const lodash = require('lodash');

// 4. Caminho absoluto
const model = require('/home/user/app/models/User');
```

### Customizando a Resolu√ß√£o

```javascript
// Adicionando diret√≥rios ao path de busca
module.paths.unshift('/meu/diretorio/customizado');

// Verificando onde um m√≥dulo seria resolvido
console.log(require.resolve('express'));
console.log(require.resolve('./utils/helpers'));

// Hook personalizado para resolu√ß√£o
const originalResolveFilename = require.extensions['.js'];
require.extensions['.js'] = function(module, filename) {
    console.log('Carregando:', filename);
    return originalResolveFilename(module, filename);
};
```

## ‚úÖ Boas Pr√°ticas

### 1. Estrutura de Exporta√ß√£o Clara

```javascript
// ‚úÖ Bom: estrutura clara e documentada
/**
 * Utilit√°rios para manipula√ß√£o de strings
 * @module StringUtils
 */

/**
 * Capitaliza a primeira letra de uma string
 * @param {string} str - String para capitalizar
 * @returns {string} String capitalizada
 */
function capitalizar(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
}

/**
 * Remove espa√ßos extras de uma string
 * @param {string} str - String para limpar
 * @returns {string} String sem espa√ßos extras
 */
function limparEspacos(str) {
    return str.replace(/\s+/g, ' ').trim();
}

module.exports = {
    capitalizar,
    limparEspacos
};
```

### 2. Valida√ß√£o de Depend√™ncias

```javascript
// ‚úÖ Bom: verificar depend√™ncias opcionais
let redis = null;
try {
    redis = require('redis');
} catch (error) {
    console.warn('Redis n√£o dispon√≠vel, usando cache em mem√≥ria');
}

function createCache() {
    if (redis) {
        return redis.createClient();
    } else {
        // Fallback para cache em mem√≥ria
        return new Map();
    }
}

module.exports = { createCache };
```

### 3. Separa√ß√£o de Responsabilidades

```javascript
// ‚úÖ Bom: cada m√≥dulo tem uma responsabilidade espec√≠fica

// models/Usuario.js - Apenas estrutura de dados
class Usuario {
    constructor(nome, email) {
        this.nome = nome;
        this.email = email;
        this.criadoEm = new Date();
    }
}

module.exports = Usuario;

// services/UsuarioService.js - L√≥gica de neg√≥cio
const Usuario = require('../models/Usuario');

class UsuarioService {
    constructor() {
        this.usuarios = [];
    }

    criar(dados) {
        const usuario = new Usuario(dados.nome, dados.email);
        this.usuarios.push(usuario);
        return usuario;
    }

    buscarPorEmail(email) {
        return this.usuarios.find(u => u.email === email);
    }
}

module.exports = UsuarioService;

// repositories/UsuarioRepository.js - Acesso a dados
class UsuarioRepository {
    constructor(database) {
        this.db = database;
    }

    async salvar(usuario) {
        const query = 'INSERT INTO usuarios (nome, email) VALUES (?, ?)';
        return await this.db.execute(query, [usuario.nome, usuario.email]);
    }

    async buscarPorId(id) {
        const query = 'SELECT * FROM usuarios WHERE id = ?';
        const [rows] = await this.db.execute(query, [id]);
        return rows[0];
    }
}

module.exports = UsuarioRepository;
```

## üöÄ Patterns Avan√ßados

### 1. Module Pattern com Estado Privado

```javascript
// services/ContadorService.js
const ContadorService = (function() {
    let contadores = new Map();
    let proximoId = 1;

    return {
        criar(nome) {
            const id = proximoId++;
            contadores.set(id, { nome, valor: 0 });
            return id;
        },

        incrementar(id) {
            const contador = contadores.get(id);
            if (contador) {
                contador.valor++;
                return contador.valor;
            }
            throw new Error('Contador n√£o encontrado');
        },

        obterValor(id) {
            const contador = contadores.get(id);
            return contador ? contador.valor : null;
        },

        listar() {
            return Array.from(contadores.entries()).map(([id, data]) => ({
                id,
                ...data
            }));
        },

        // M√©todo para testes
        _limpar() {
            contadores.clear();
            proximoId = 1;
        }
    };
})();

module.exports = ContadorService;
```

### 2. Plugin System

```javascript
// core/PluginManager.js
class PluginManager {
    constructor() {
        this.plugins = new Map();
        this.hooks = new Map();
    }

    register(name, plugin) {
        if (typeof plugin.init === 'function') {
            plugin.init(this);
        }
        
        this.plugins.set(name, plugin);
        
        // Registrar hooks do plugin
        if (plugin.hooks) {
            Object.entries(plugin.hooks).forEach(([hookName, callback]) => {
                this.addHook(hookName, callback);
            });
        }
    }

    addHook(name, callback) {
        if (!this.hooks.has(name)) {
            this.hooks.set(name, []);
        }
        this.hooks.get(name).push(callback);
    }

    async executeHook(name, data) {
        const callbacks = this.hooks.get(name) || [];
        
        for (const callback of callbacks) {
            try {
                data = await callback(data) || data;
            } catch (error) {
                console.error(`Erro no hook ${name}:`, error);
            }
        }
        
        return data;
    }

    getPlugin(name) {
        return this.plugins.get(name);
    }

    listPlugins() {
        return Array.from(this.plugins.keys());
    }
}

module.exports = PluginManager;
```

### 3. Dependency Injection

```javascript
// core/Container.js
class Container {
    constructor() {
        this.services = new Map();
        this.singletons = new Map();
    }

    register(name, factory, options = {}) {
        this.services.set(name, {
            factory,
            singleton: options.singleton || false,
            dependencies: options.dependencies || []
        });
    }

    get(name) {
        const service = this.services.get(name);
        
        if (!service) {
            throw new Error(`Servi√ßo '${name}' n√£o encontrado`);
        }

        // Retornar singleton se j√° existe
        if (service.singleton && this.singletons.has(name)) {
            return this.singletons.get(name);
        }

        // Resolver depend√™ncias
        const dependencies = service.dependencies.map(dep => this.get(dep));
        
        // Criar inst√¢ncia
        const instance = service.factory(...dependencies);

        // Armazenar singleton
        if (service.singleton) {
            this.singletons.set(name, instance);
        }

        return instance;
    }

    has(name) {
        return this.services.has(name);
    }
}

module.exports = Container;

// Uso do container
const container = new Container();

// Registrar servi√ßos
container.register('logger', () => require('./utils/logger'), { singleton: true });
container.register('database', () => require('./database'), { singleton: true });
container.register('userService', (logger, db) => {
    const UserService = require('./services/UserService');
    return new UserService(logger, db);
}, { dependencies: ['logger', 'database'] });

// Usar servi√ßos
const userService = container.get('userService');
```

## üîß Debugging e Troubleshooting

### Debugging de M√≥dulos

```javascript
// Debug da resolu√ß√£o de m√≥dulos
process.env.NODE_DEBUG = 'module';

// Interceptar carregamento de m√≥dulos
const originalRequire = require;
require = function(id) {
    console.log(`Carregando m√≥dulo: ${id}`);
    return originalRequire.apply(this, arguments);
};

// Listar m√≥dulos carregados
function listarModulosCarregados() {
    console.log('M√≥dulos em cache:');
    Object.keys(require.cache).forEach((module, index) => {
        console.log(`${index + 1}. ${module}`);
    });
}
```

### Tratamento de Erros

```javascript
// utils/moduleLoader.js
function carregarModuloSeguro(modulePath, fallback = null) {
    try {
        return require(modulePath);
    } catch (error) {
        console.error(`Erro ao carregar m√≥dulo ${modulePath}:`, error.message);
        
        if (fallback && typeof fallback === 'function') {
            return fallback();
        }
        
        return fallback;
    }
}

function validarModulo(modulo, requisitos = []) {
    for (const requisito of requisitos) {
        if (!(requisito in modulo)) {
            throw new Error(`M√≥dulo n√£o possui propriedade: ${requisito}`);
        }
    }
    return true;
}

module.exports = {
    carregarModuloSeguro,
    validarModulo
};
```

## üìö Recursos e Refer√™ncias

### Documenta√ß√£o Oficial
- [Node.js Modules](https://nodejs.org/api/modules.html)
- [CommonJS Specification](http://www.commonjs.org/specs/modules/1.0/)

### Ferramentas √öteis
- **nodemon**: Reinicia automaticamente a aplica√ß√£o
- **require-dir**: Carrega todos os m√≥dulos de um diret√≥rio
- **proxyquire**: Mock de m√≥dulos para testes

### Exemplo de package.json para CommonJS

```json
{
  "name": "projeto-commonjs",
  "version": "1.0.0",
  "description": "Projeto usando CommonJS",
  "main": "index.js",
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js",
    "test": "jest"
  },
  "engines": {
    "node": ">=14.0.0"
  },
  "keywords": ["nodejs", "commonjs", "modules"],
  "author": "Seu Nome",
  "license": "MIT"
}
```

---

**üí° Dica Final**: CommonJS √© excelente para projetos Node.js tradicionais, oferece simplicidade e compatibilidade total. √â ideal quando voc√™ n√£o precisa das funcionalidades avan√ßadas dos ES Modules.

**Desenvolvido como parte dos estudos na DIO** üöÄ
